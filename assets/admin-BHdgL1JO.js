import{s as j,h as $,a as u,i as q}from"./snow-CPm8NqrG.js";const D="Purple-EyeZ/Plugins-List",J=`https://api.github.com/repos/${D}/contents/src/plugins-data.json?ref=dev`;async function I(e){const n=e.endsWith("/")?`${e}manifest.json`:`${e}/manifest.json`,t=await fetch(n);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}async function R(){const e=await fetch(J),n=await e.json();if(!e.ok)throw new Error(n.message||"Failed to fetch from GitHub API");const t=atob(n.content),s=new Uint8Array(t.length);for(let o=0;o<t.length;o++)s[o]=t.charCodeAt(o);const a=new TextDecoder("utf-8").decode(s);return JSON.parse(a)}async function F(e){const n=JSON.stringify(e,null,4),t=await fetch("/api/save-plugins",{method:"POST",headers:{"Content-Type":"application/json"},body:n});if(!t.ok)throw new Error(`Save failed: ${t.statusText}`);return t.json()}async function G(e,n,t){try{if(n==="sourceUrl")return e.sourceUrl=t(e.installUrl),!0;const s=await I(e.installUrl);switch(n){case"name":e.name=s.name;break;case"description":e.description=s.description;break;case"authors":e.authors=s.authors?.map(a=>a.name)||["Unknown"];break;default:return!1}return!0}catch(s){return console.error(`Error updating ${n}:`,s),!1}}async function V(e,n){const t=await I(e);return{name:t.name,description:t.description,authors:t.authors?.map(s=>s.name)||["Unknown"],status:"working",sourceUrl:n(e),installUrl:e,warningMessage:""}}async function W(e){let n=0,t=0;const s=e.map(async a=>{try{const o=await I(a.installUrl),i=o.authors?.map(r=>r.name)||["Unknown"],l=[],c=a.name;o.name&&o.name!==a.name&&(l.push(`  - Name: "${a.name}" â†’ "${o.name}"`),a.name=o.name),o.description&&o.description!==a.description&&(l.push("  - Description updated."),a.description=o.description),JSON.stringify(i)!==JSON.stringify(a.authors)&&(l.push(`  - Authors: "${a.authors.join(", ")}" â†’ "${i.join(", ")}"`),a.authors=i),l.length>0&&(console.groupCollapsed(`ðŸ”„ Changes found for: ${c}`),l.forEach(r=>{console.log(r)}),console.groupEnd(),n++)}catch(o){console.error(`âŒ Error updating ${a.name}:`,o.message),t++}});return await Promise.all(s),{updatedCount:n,failedCount:t}}function O(e,n){if(!n||n.length===0)return null;const t=document.createElement("div"),s=n.map(a=>`<li>${a.name}</li>`).join("");return t.innerHTML=`<h4>${e}</h4><ul>${s}</ul>`,t}function _(e,n,t){const s=document.getElementById("review-changes-template"),a=document.createElement("div"),o=O("ðŸš€ Added Plugins:",e.added);o&&a.appendChild(o);const i=O("ðŸ—‘ï¸ Deleted Plugins:",e.deleted);if(i&&a.appendChild(i),e.modified.length>0){const r=document.createElement("h4");r.innerHTML="âœï¸ Modified Plugins:",a.appendChild(r),e.modified.forEach(({plugin:m,fields:g})=>{const y=s.content.cloneNode(!0),p=y.querySelector(".field-changes-list");y.querySelector(".review-plugin-name").textContent=m.name,g.forEach(({field:h,oldValue:k,newValue:U})=>{const E=document.createElement("div");E.className="field-change";const C=document.createElement("div");C.className="field-change-header";const N=document.createElement("span");N.className="field-name",N.textContent=h;const v=document.createElement("button");v.className="btn btn--small btn--danger revert-change",v.textContent="Revert",v.dataset.url=m.installUrl,v.dataset.field=h,C.appendChild(N),C.appendChild(v);const b=document.createElement("div");b.className="diff-container";const x=document.createElement("div");x.className="diff-view old-value",x.textContent=typeof k=="string"?k:JSON.stringify(k,null,2);const L=document.createElement("div");L.className="diff-view new-value",L.textContent=typeof U=="string"?U:JSON.stringify(U,null,2),b.appendChild(x),b.appendChild(L),E.appendChild(C),E.appendChild(b),p.appendChild(E)}),a.appendChild(y)})}const l=document.createElement("div"),c=document.createElement("p");c.className="popup-message",c.textContent="The following changes will be committed to the dev branch:",l.appendChild(c),l.appendChild(a),l.addEventListener("click",r=>{if(r.target.classList.contains("revert-change")){const m=r.target.dataset.url,g=r.target.dataset.field;t(m,g)}}),j({title:"Review Changes",contentElement:l,primaryButton:{text:"Confirm & Save",action:()=>{n(),$()}},secondaryButton:{text:"Cancel",action:$},closeOnOutsideClick:!0})}function K(e,n,t,s,a){e.textContent=a.total,n.textContent=a.working,t.textContent=a.warning,s.textContent=a.broken}function Z(e,n){const t=document.getElementById("admin-plugin-template");if(!t)return null;const s=t.content.cloneNode(!0).querySelector(".admin-plugin-item");return s.querySelector(".plugin-name").textContent=e.name||"Unnamed Plugin",s.querySelector(".status-select").value=e.status,s.querySelector(".warning-message").value=e.warningMessage||"",s.querySelector(".status-select").addEventListener("change",a=>n.onStatusChange(a.target.value)),s.querySelector(".warning-message").addEventListener("input",a=>n.onWarningChange(a.target.value)),s.querySelector(".delete-plugin").addEventListener("click",n.onDelete),s.querySelector(".edit-plugin").addEventListener("click",n.onEdit),s}function z(e,n,t,s){e.innerHTML="";let a=n;t!=="all"&&(a=n.filter(i=>i.status===t));const o=[];for(const i of a){const c=Z(i,{onStatusChange:r=>s.onPluginUpdate(i,"status",r),onWarningChange:r=>s.onPluginUpdate(i,"warningMessage",r),onDelete:()=>s.onPluginDelete(i),onEdit:()=>s.onPluginEdit(i)});o.push(c),e.appendChild(c)}return{renderedPlugins:a,renderedElements:o}}function Q(e,n,t){const s=document.getElementById("edit-popup-template");if(!s)return;const a=s.content.cloneNode(!0),o=a.querySelector(".plugin-details-form"),i={},l=[{id:"name",label:"Name",value:e.name,type:"input"},{id:"description",label:"Description",value:e.description,type:"textarea"},{id:"authors",label:"Authors",value:e.authors?.join(", "),type:"input"},{id:"installUrl",label:"Install URL",value:e.installUrl,type:"input",noRefetch:!0},{id:"sourceUrl",label:"Source URL",value:e.sourceUrl,type:"input"}];for(const c of l){const r=document.createElement("div");r.className="form-group";const m=document.createElement("label");m.textContent=`${c.label}:`;const g=document.createElement("div");g.className="input-with-button";const y=c.type==="textarea",p=document.createElement(y?"textarea":"input");if(y||(p.type="text"),p.id=`plugin-${c.id}`,p.className="form-control",p.value=c.value||"",i[c.id]=p,g.appendChild(p),!c.noRefetch){const h=document.createElement("button");h.className="btn btn--secondary admin-button refetch-field",h.dataset.field=c.id,h.innerHTML='<span class="material-symbols-rounded">refresh</span>',g.appendChild(h)}r.appendChild(m),r.appendChild(g),o.appendChild(r)}for(const c of a.querySelectorAll(".refetch-field"))c.addEventListener("click",async()=>{const r=c.dataset.field;await t(e,r)?(r==="authors"?i.authors.value=e.authors.join(", "):i[r].value=e[r],u(`${r} updated successfully!`)):u(`Failed to update ${r}`)});j({title:`Edit Plugin: ${e.name}`,contentElement:a,primaryButton:{text:"Save",action:()=>{const c={name:i.name.value,description:i.description.value,authors:i.authors.value.split(",").map(r=>r.trim()),installUrl:i.installUrl.value,sourceUrl:i.sourceUrl.value};n(c),$()}},closeOnOutsideClick:!0})}let d=[],w=[],A="all";const X=document.getElementById("plugins-list"),Y=document.getElementById("add-plugin-form"),M=document.getElementById("new-plugin-url"),ee=document.getElementById("save-changes"),te=document.getElementById("check-plugins"),B={all:document.getElementById("filter-all"),broken:document.getElementById("filter-broken"),warning:document.getElementById("filter-warning")},P={total:document.getElementById("total-count"),working:document.getElementById("working-count"),warning:document.getElementById("warning-count"),broken:document.getElementById("broken-count")},S=q({containerId:"plugins-list",itemClass:"admin-plugin-item",searchKeys:["name","authors","description","warningMessage"],priorityKey:"name",subtextMessage:e=>`Found ${e} matching plugin${e===1?"":"s"}`,renderFunction:f,displayStyle:"block"});function T(e,n){const t={added:[],deleted:[],modified:[]},s=new Map(e.map(o=>[o.installUrl,o])),a=new Map(n.map(o=>[o.installUrl,o]));for(const[o,i]of a.entries()){const l=s.get(o);if(!l)t.added.push(i);else{const c=[];for(const r in i){const m=JSON.stringify(l[r]),g=JSON.stringify(i[r]);m!==g&&c.push({field:r,oldValue:l[r],newValue:i[r]})}c.length>0&&t.modified.push({plugin:i,fields:c})}}for(const[o,i]of s.entries())a.has(o)||t.deleted.push(i);return t}function H(e){if(e=e.replace(/\/$/,""),e.includes("/proxy/")){const n=e.split("/proxy/")[1];if(n){const t=n.match(/([^.]+)\.github\.io\/([^/]+)/);if(t){const[,a,o]=t;return`https://github.com/${a}/${o}`}const s=n.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)/);if(s){const[,a,o]=s;return`https://github.com/${a}/${o}`}}}if(e.includes("github.io")){const n=e.match(/https?:\/\/([^.]+)\.github\.io\/([^/]+)/);if(n){const[,t,s]=n;return`https://github.com/${t}/${s}`}}if(e.includes("raw.githubusercontent.com")){const n=e.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)/);if(n){const[,t,s]=n;return`https://github.com/${t}/${s}`}}return e}function f(e=!1){const{renderedPlugins:n,renderedElements:t}=z(X,d,A,{onPluginUpdate:ne,onPluginDelete:ae,onPluginEdit:se});S.prepareSearchableData(n,t);const s={total:d.length,working:d.filter(a=>a.status==="working").length,warning:d.filter(a=>a.status==="warning").length,broken:d.filter(a=>a.status==="broken").length};K(P.total,P.working,P.warning,P.broken,s),e||S.filterItems(S.getCurrentValue())}function ne(e,n,t){e[n]=t,n==="status"&&f()}function ae(e){confirm(`Delete plugin "${e.name}"?`)&&(d=d.filter(n=>n!==e),f())}function se(e){Q(e,t=>{const s=d.indexOf(e);s!==-1&&(d[s]={...d[s],...t}),f(),u("Plugin details updated!")},async(t,s)=>{const a=await G(t,s,H);return a&&f(),a})}Y.addEventListener("submit",async e=>{e.preventDefault();const n=M.value.trim();if(n)try{const t=await V(n,H);d.push(t),f(),M.value="",u("Plugin added successfully!")}catch(t){u(`Error adding plugin: ${t.message}`)}});ee.addEventListener("click",async()=>{const e=T(w,d);if(!(e.added.length>0||e.deleted.length>0||e.modified.length>0)){u("No changes to save.");return}const t=()=>{const s=T(w,d);_(s,async()=>{try{const a=await F(d);u(a.message||"Changes saved successfully!"),w=JSON.parse(JSON.stringify(d))}catch(a){u(`Error saving changes: ${a.message}`)}},(a,o)=>{const i=w.find(c=>c.installUrl===a),l=d.find(c=>c.installUrl===a);l&&i&&(l[o]=i[o],f(),$(),t(),u(`Reverted change for ${l.name}'s ${o}.`))})};t()});te.addEventListener("click",async()=>{console.group("Updating plugin manifests...");const{updatedCount:e,failedCount:n}=await W(d);console.log(`
Update summary:`),console.log(`âœ… Successfully updated: ${e} plugins`),console.log(`âŒ Failed to update: ${n} plugins`),console.groupEnd(),f(),u(`Updated ${e} plugins (${n} failed)`)});Object.entries(B).forEach(([e,n])=>{n.addEventListener("click",()=>{A=e,Object.values(B).forEach(t=>{t.classList.remove("active")}),n.classList.add("active"),f()})});async function oe(){try{w=await R(),d=JSON.parse(JSON.stringify(w)),B.all.classList.add("active"),f(),S.initSearchFromURL()}catch(e){u(`Error loading plugins: ${e.message}`)}}oe();
