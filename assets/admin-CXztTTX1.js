import{s as M,h as S,a as u,i as H,p as q,f as D,b as J,c as R}from"./snow-BWKBcfrg.js";const F="Purple-EyeZ/Plugins-List",G=`https://api.github.com/repos/${F}/contents/src/plugins-data.json?ref=dev`;async function B(e){const n=e.endsWith("/")?`${e}manifest.json`:`${e}/manifest.json`,t=await fetch(n);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}async function V(){const e=await fetch(G),n=await e.json();if(!e.ok)throw new Error(n.message||"Failed to fetch from GitHub API");const t=atob(n.content),a=new Uint8Array(t.length);for(let s=0;s<t.length;s++)a[s]=t.charCodeAt(s);const o=new TextDecoder("utf-8").decode(a);return JSON.parse(o)}async function W(e){const n=JSON.stringify(e,null,4),t=await fetch("/api/save-plugins",{method:"POST",headers:{"Content-Type":"application/json"},body:n});if(!t.ok)throw new Error(`Save failed: ${t.statusText}`);return t.json()}async function _(e,n,t){try{if(n==="sourceUrl")return e.sourceUrl=t(e.installUrl),!0;const a=await B(e.installUrl);switch(n){case"name":e.name=a.name;break;case"description":e.description=a.description;break;case"authors":e.authors=a.authors?.map(o=>o.name)||["Unknown"];break;default:return!1}return!0}catch(a){return console.error(`Error updating ${n}:`,a),!1}}async function Z(e,n){const t=await B(e);return{name:t.name,description:t.description,authors:t.authors?.map(a=>a.name)||["Unknown"],status:"working",sourceUrl:n(e),installUrl:e,warningMessage:""}}async function z(e){let n=0,t=0;const a=e.map(async o=>{try{const s=await B(o.installUrl),i=s.authors?.map(r=>r.name)||["Unknown"],l=[],c=o.name;s.name&&s.name!==o.name&&(l.push(`  - Name: "${o.name}" â†’ "${s.name}"`),o.name=s.name),s.description&&s.description!==o.description&&(l.push("  - Description updated."),o.description=s.description),JSON.stringify(i)!==JSON.stringify(o.authors)&&(l.push(`  - Authors: "${o.authors.join(", ")}" â†’ "${i.join(", ")}"`),o.authors=i),l.length>0&&(console.groupCollapsed(`ðŸ”„ Changes found for: ${c}`),l.forEach(r=>{console.log(r)}),console.groupEnd(),n++)}catch(s){console.error(`âŒ Error updating ${o.name}:`,s.message),t++}});return await Promise.all(a),{updatedCount:n,failedCount:t}}function I(e,n){if(!n||n.length===0)return null;const t=document.createElement("div"),a=n.map(o=>`<li>${o.name}</li>`).join("");return t.innerHTML=`<h4>${e}</h4><ul>${a}</ul>`,t}function K(e,n,t){const a=document.getElementById("review-changes-template"),o=document.createElement("div"),s=I("ðŸš€ Added Plugins:",e.added);s&&o.appendChild(s);const i=I("ðŸ—‘ï¸ Deleted Plugins:",e.deleted);if(i&&o.appendChild(i),e.modified.length>0){const r=document.createElement("h4");r.innerHTML="âœï¸ Modified Plugins:",o.appendChild(r),e.modified.forEach(({plugin:m,fields:f})=>{const y=a.content.cloneNode(!0),p=y.querySelector(".field-changes-list");y.querySelector(".review-plugin-name").textContent=m.name,f.forEach(({field:h,oldValue:$,newValue:k})=>{const E=document.createElement("div");E.className="field-change";const C=document.createElement("div");C.className="field-change-header";const U=document.createElement("span");U.className="field-name",U.textContent=h;const w=document.createElement("button");w.className="btn btn--small btn--danger revert-change",w.textContent="Revert",w.dataset.url=m.installUrl,w.dataset.field=h,C.appendChild(U),C.appendChild(w);const b=document.createElement("div");b.className="diff-container";const N=document.createElement("div");N.className="diff-view old-value",N.textContent=typeof $=="string"?$:JSON.stringify($,null,2);const x=document.createElement("div");x.className="diff-view new-value",x.textContent=typeof k=="string"?k:JSON.stringify(k,null,2),b.appendChild(N),b.appendChild(x),E.appendChild(C),E.appendChild(b),p.appendChild(E)}),o.appendChild(y)})}const l=document.createElement("div"),c=document.createElement("p");c.className="popup-message",c.textContent="The following changes will be committed to the dev branch:",l.appendChild(c),l.appendChild(o),l.addEventListener("click",r=>{if(r.target.classList.contains("revert-change")){const m=r.target.dataset.url,f=r.target.dataset.field;t(m,f)}}),M({title:"Review Changes",contentElement:l,primaryButton:{text:"Confirm & Save",action:()=>{n(),S()}},secondaryButton:{text:"Cancel",action:S},closeOnOutsideClick:!0})}function Q(e,n,t,a,o){e.textContent=o.total,n.textContent=o.working,t.textContent=o.warning,a.textContent=o.broken}function X(e,n){const t=document.getElementById("admin-plugin-template");if(!t)return null;const a=t.content.cloneNode(!0).querySelector(".admin-plugin-item");return a.querySelector(".plugin-name").textContent=e.name||"Unnamed Plugin",a.querySelector(".status-select").value=e.status,a.querySelector(".warning-message").value=e.warningMessage||"",a.querySelector(".status-select").addEventListener("change",o=>n.onStatusChange(o.target.value)),a.querySelector(".warning-message").addEventListener("input",o=>n.onWarningChange(o.target.value)),a.querySelector(".delete-plugin").addEventListener("click",n.onDelete),a.querySelector(".edit-plugin").addEventListener("click",n.onEdit),a}function Y(e,n,t,a){e.innerHTML="";let o=n;t!=="all"&&(o=n.filter(i=>i.status===t));const s=[];for(const i of o){const c=X(i,{onStatusChange:r=>a.onPluginUpdate(i,"status",r),onWarningChange:r=>a.onPluginUpdate(i,"warningMessage",r),onDelete:()=>a.onPluginDelete(i),onEdit:()=>a.onPluginEdit(i)});s.push(c),e.appendChild(c)}return{renderedPlugins:o,renderedElements:s}}function ee(e,n,t){const a=document.getElementById("edit-popup-template");if(!a)return;const o=a.content.cloneNode(!0),s=o.querySelector(".plugin-details-form"),i={},l=[{id:"name",label:"Name",value:e.name,type:"input"},{id:"description",label:"Description",value:e.description,type:"textarea"},{id:"authors",label:"Authors",value:e.authors?.join(", "),type:"input"},{id:"installUrl",label:"Install URL",value:e.installUrl,type:"input",noRefetch:!0},{id:"sourceUrl",label:"Source URL",value:e.sourceUrl,type:"input"}];for(const c of l){const r=document.createElement("div");r.className="form-group";const m=document.createElement("label");m.textContent=`${c.label}:`;const f=document.createElement("div");f.className="input-with-button";const y=c.type==="textarea",p=document.createElement(y?"textarea":"input");if(y||(p.type="text"),p.id=`plugin-${c.id}`,p.className="form-control",p.value=c.value||"",i[c.id]=p,f.appendChild(p),!c.noRefetch){const h=document.createElement("button");h.className="btn btn--secondary admin-button refetch-field",h.dataset.field=c.id,h.innerHTML='<span class="material-symbols-rounded">refresh</span>',f.appendChild(h)}r.appendChild(m),r.appendChild(f),s.appendChild(r)}for(const c of o.querySelectorAll(".refetch-field"))c.addEventListener("click",async()=>{const r=c.dataset.field;await t(e,r)?(r==="authors"?i.authors.value=e.authors.join(", "):i[r].value=e[r],u(`${r} updated successfully!`)):u(`Failed to update ${r}`)});M({title:`Edit Plugin: ${e.name}`,contentElement:o,primaryButton:{text:"Save",action:()=>{const c={name:i.name.value,description:i.description.value,authors:i.authors.value.split(",").map(r=>r.trim()),installUrl:i.installUrl.value,sourceUrl:i.sourceUrl.value};n(c),S()}},closeOnOutsideClick:!0})}let d=[],v=[],j="all";const te=document.getElementById("plugins-list"),ne=document.getElementById("add-plugin-form"),O=document.getElementById("new-plugin-url"),ae=document.getElementById("save-changes"),oe=document.getElementById("check-plugins"),L={all:document.getElementById("filter-all"),broken:document.getElementById("filter-broken"),warning:document.getElementById("filter-warning")},P={total:document.getElementById("total-count"),working:document.getElementById("working-count"),warning:document.getElementById("warning-count"),broken:document.getElementById("broken-count")};function T(e,n){const t={added:[],deleted:[],modified:[]},a=new Map(e.map(s=>[s.installUrl,s])),o=new Map(n.map(s=>[s.installUrl,s]));for(const[s,i]of o.entries()){const l=a.get(s);if(!l)t.added.push(i);else{const c=[];for(const r in i){const m=JSON.stringify(l[r]),f=JSON.stringify(i[r]);m!==f&&c.push({field:r,oldValue:l[r],newValue:i[r]})}c.length>0&&t.modified.push({plugin:i,fields:c})}}for(const[s,i]of a.entries())o.has(s)||t.deleted.push(i);return t}function A(e){if(e=e.replace(/\/$/,""),e.includes("/proxy/")){const n=e.split("/proxy/")[1];if(n){const t=n.match(/([^.]+)\.github\.io\/([^/]+)/);if(t){const[,o,s]=t;return`https://github.com/${o}/${s}`}const a=n.match(/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)/);if(a){const[,o,s]=a;return`https://github.com/${o}/${s}`}}}if(e.includes("github.io")){const n=e.match(/https?:\/\/([^.]+)\.github\.io\/([^/]+)/);if(n){const[,t,a]=n;return`https://github.com/${t}/${a}`}}if(e.includes("raw.githubusercontent.com")){const n=e.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)/);if(n){const[,t,a]=n;return`https://github.com/${t}/${a}`}}return e}function g(){H();const{renderedPlugins:e,renderedElements:n}=Y(te,d,j,{onPluginUpdate:se,onPluginDelete:ie,onPluginEdit:re});q(e,n);const t={total:d.length,working:d.filter(a=>a.status==="working").length,warning:d.filter(a=>a.status==="warning").length,broken:d.filter(a=>a.status==="broken").length};Q(P.total,P.working,P.warning,P.broken,t),D(J.currentValue)}function se(e,n,t){e[n]=t,n==="status"&&g()}function ie(e){confirm(`Delete plugin "${e.name}"?`)&&(d=d.filter(n=>n!==e),g())}function re(e){ee(e,t=>{const a=d.indexOf(e);a!==-1&&(d[a]={...d[a],...t}),g(),u("Plugin details updated!")},async(t,a)=>{const o=await _(t,a,A);return o&&g(),o})}ne.addEventListener("submit",async e=>{e.preventDefault();const n=O.value.trim();if(n)try{const t=await Z(n,A);d.push(t),g(),O.value="",u("Plugin added successfully!")}catch(t){u(`Error adding plugin: ${t.message}`)}});ae.addEventListener("click",async()=>{const e=T(v,d);if(!(e.added.length>0||e.deleted.length>0||e.modified.length>0)){u("No changes to save.");return}const t=()=>{const a=T(v,d);K(a,async()=>{try{const o=await W(d);u(o.message||"Changes saved successfully!"),v=JSON.parse(JSON.stringify(d))}catch(o){u(`Error saving changes: ${o.message}`)}},(o,s)=>{const i=v.find(c=>c.installUrl===o),l=d.find(c=>c.installUrl===o);l&&i&&(l[s]=i[s],g(),S(),t(),u(`Reverted change for ${l.name}'s ${s}.`))})};t()});oe.addEventListener("click",async()=>{console.group("Updating plugin manifests...");const{updatedCount:e,failedCount:n}=await z(d);console.log(`
Update summary:`),console.log(`âœ… Successfully updated: ${e} plugins`),console.log(`âŒ Failed to update: ${n} plugins`),console.groupEnd(),g(),u(`Updated ${e} plugins (${n} failed)`)});Object.entries(L).forEach(([e,n])=>{n.addEventListener("click",()=>{j=e,Object.values(L).forEach(t=>{t.classList.remove("active")}),n.classList.add("active"),g()})});async function ce(){try{v=await V(),d=JSON.parse(JSON.stringify(v)),L.all.classList.add("active"),g(),R()}catch(e){u(`Error loading plugins: ${e.message}`)}}ce();
